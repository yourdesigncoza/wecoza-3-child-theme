<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Learner Synchronization</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>Test Learner Synchronization</h2>
        
        <!-- Hidden field for class learners data -->
        <input type="hidden" id="class_learners_data" name="class_learners_data" value="">
        
        <!-- Mock class learners table (simulates dynamic table) -->
        <div class="mb-4">
            <h4>Class Learners Table</h4>
            <table id="class-learners-table" class="table table-striped">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>101</td>
                        <td>John Smith</td>
                        <td>Active</td>
                    </tr>
                    <tr>
                        <td>102</td>
                        <td>Jane Doe</td>
                        <td>Active</td>
                    </tr>
                    <tr>
                        <td>103</td>
                        <td>Bob Johnson</td>
                        <td>Active</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Exam learner select (should be populated) -->
        <div class="mb-4">
            <h4>Exam Learner Select</h4>
            <select id="exam_learner_select" name="exam_learner_select[]" class="form-select form-select-sm" multiple>
                <!-- Will be populated dynamically -->
            </select>
            <small class="text-muted">This should be populated with learners from the table above.</small>
        </div>
        
        <!-- Test controls -->
        <div class="mb-4">
            <button id="test-sync-btn" class="btn btn-primary">Test Synchronization</button>
            <button id="clear-select-btn" class="btn btn-secondary">Clear Select</button>
        </div>
        
        <!-- Status display -->
        <div class="mb-4">
            <h5>Status:</h5>
            <div id="status-display" class="alert alert-info">
                Ready to test...
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // Mock the legacy synchronization function
        window.classes_sync_exam_learner_options = function () {
            const $examLearnersContainer = $('#exam_learners_container');
            const $examLearnerSelect = $('#exam_learner_select');

            if (!$examLearnerSelect.length) {
                $('#status-display').html('<strong>Exam learner select not found!</strong>').removeClass('alert-info').addClass('alert-danger');
                return;
            }

            // Get the current class learners data
            const classLearnersData = JSON.parse($('#class_learners_data').val() || '[]');

            // Get current exam learners data to exclude them from options
            const examLearnersData = JSON.parse($('#exam_learners').val() || '[]');

            // Clear current options
            $examLearnerSelect.empty();

            // Add options for each class learner that's not already in exam learners
            classLearnersData.forEach(function (learner) {
                if (!examLearnersData.some(el => String(el.id) === String(learner.id))) {
                    $examLearnerSelect.append(`<option value="${learner.id}">${learner.name}</option>`);
                }
            });

            $('#status-display').html(`<strong>Success!</strong> Synchronized ${classLearnersData.length} learners to exam learner select.`).removeClass('alert-info alert-danger').addClass('alert-success');
        };

        // Our synchronization function
        function syncClassLearnersFromTable() {
            const $classLearnersTable = $('#class-learners-table');
            const $wecozaDynamicTable = $('#wecoza-dynamic-table');
            
            // Try to find learners in class-learners-table first, then wecoza-dynamic-table
            const $targetTable = $classLearnersTable.length ? $classLearnersTable : $wecozaDynamicTable;
            
            if (!$targetTable.length) {
                $('#status-display').html('<strong>No table found!</strong>').removeClass('alert-info').addClass('alert-danger');
                return;
            }
            
            const learners = [];
            
            // Extract learner data from table rows
            $targetTable.find('tbody tr').each(function() {
                const $row = $(this);
                const cells = $row.find('td');
                
                if (cells.length >= 2) {
                    // Try to determine ID and name based on column order
                    let learnerId = '';
                    let learnerName = '';
                    
                    // Check if first column contains ID (numeric) or name (text)
                    const firstCell = $(cells[0]).text().trim();
                    const secondCell = $(cells[1]).text().trim();
                    
                    // If first cell is numeric, assume it's ID, second is name
                    if (/^\d+$/.test(firstCell)) {
                        learnerId = firstCell;
                        learnerName = secondCell;
                    } else {
                        // If first cell is text, try to find ID in other columns
                        learnerName = firstCell;
                        // Look for numeric ID in subsequent columns
                        for (let i = 1; i < cells.length; i++) {
                            const cellText = $(cells[i]).text().trim();
                            if (/^\d+$/.test(cellText)) {
                                learnerId = cellText;
                                break;
                            }
                        }
                        // If no numeric ID found, use first cell as both ID and name
                        if (!learnerId) {
                            learnerId = firstCell;
                        }
                    }
                    
                    if (learnerId && learnerName) {
                        learners.push({
                            id: learnerId.toString(),
                            name: learnerName
                        });
                    }
                }
            });
            
            // Update the class_learners_data hidden field if it exists
            const $classLearnersData = $('#class_learners_data');
            if ($classLearnersData.length) {
                $classLearnersData.val(JSON.stringify(learners));
                console.log('Updated class_learners_data with', learners.length, 'learners');
                
                // Trigger the legacy synchronization function
                if (typeof window.classes_sync_exam_learner_options === 'function') {
                    window.classes_sync_exam_learner_options();
                }
            }
        }

        $(document).ready(function() {
            // Test button click
            $('#test-sync-btn').click(function() {
                $('#status-display').html('Testing synchronization...').removeClass('alert-success alert-danger').addClass('alert-info');
                syncClassLearnersFromTable();
            });
            
            // Clear button click
            $('#clear-select-btn').click(function() {
                $('#exam_learner_select').empty();
                $('#class_learners_data').val('');
                $('#status-display').html('Cleared...').removeClass('alert-success alert-danger').addClass('alert-info');
            });
        });
    </script>
</body>
</html>
